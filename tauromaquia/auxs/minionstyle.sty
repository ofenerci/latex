% Have faith in the way things are.
%
% minionstyle
% LaTeX style file based on Minion-Pro font
% copyright 2013 rimbaudcode
%
% License:
%   This program is free software: you can redistribute it and/or modify
%   it under the terms of the GNU General Public License as published by
%   the Free Software Foundation, either version 3 of the License, or
%   (at your option) any later version.
%
%   This program is distributed in the hope that it will be useful,
%   but WITHOUT ANY WARRANTY; without even the implied warranty of
%   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%   GNU General Public License for more details.
%
%   You should have received a copy of the GNU General Public License
%   along with this program.  If not, see <http://www.gnu.org/licenses/>.
%
% * warning: set editor encoding to UTF-8
%            compile with XeLaTeX
%            coded using monospaced font without tabs (only spaced)
%
% * usage:
%
% * restriction: full LaTeX distribution
%                minion pro must be installed in the OS font directory
%
% * algorithms: based on the classic-thesis package
%
% * references: A Classic Thesis Style. AndrÃ© Miede
%               LaTeX package documentations
%               Main package: KOMA-Script
%
% * file formats: include the style file: minionstyle.sty

\ProvidesPackage{minionstyle}[27/12/2013 minionstyle (rimbaudcode)]

\RequirePackage{scrhack}  % fixes conflicts with KomaScript
\RequirePackage{fixltx2e} % Fixes some LaTeX stuff
%
%\RequirePackage[printonlyused,smaller]{acronym}% Acronyms
\RequirePackage{amsmath}                        % Maths
\RequirePackage{amsfonts}                       % Maths
\RequirePackage{amssymb}                        % Maths
%\RequirePackage{amsthm}                        % Maths (theorems)
\RequirePackage{booktabs}                       % Tables
\RequirePackage[dvipsnames,table]{xcolor}       % [dvipsnames]

\RequirePackage{float}                      % \begin{table}[H]
\RequirePackage{lastpage}                   % last page: \pageref
%\RequirePackage{lineno}                    % line numbers on paragraphs
%\RequirePackage{listings}                  % Fine typesetting of code listings!
%\RequirePackage{lscape}                    % \begin{landscape}...\end{landscape}
\RequirePackage{marginnote}                 % Margin notes
\RequirePackage[version=3]{mhchem}          % chemistry
\RequirePackage[protrusion=true]{microtype} % no expansion with xelatex :(
\RequirePackage{mparhack}                   % Marginpar right

\RequirePackage{multicol}               % Multicol
\RequirePackage{multirow}               % Multirow
%\RequirePackage{paralist}              % Paragraph lists! (list env. in paragraphs)
\RequirePackage[draft]{prelim2e}        % Final and draft versions
%\RequirePackage{ucs}                   % Encoding
%\RequirePackage{rotating}              % Rotate tables
\RequirePackage[square,numbers]{natbib} % References

\RequirePackage{tabularx}           % Tables
\RequirePackage{textcase}           % \MakeTextUppercase
%\RequirePackage{textcomp}          % Symbols and old style numerals
\RequirePackage{titlesec}           % Custom sections
\RequirePackage[titles]{tocloft}    % TOC
%\RequirePackage{scalefnt}          % scale fonts {\scalefont{5} test}
\RequirePackage[automark]{scrpage2} % Headers and footers
\RequirePackage{scrtime}            % Date and time access
\RequirePackage{siunitx}            %

% Subfigures in figures (different from \subfigure package)
% the \subfigure package does not work (there is a conflict with TOC)
\RequirePackage{subfig}

\RequirePackage{verbatim} % verbatim
\RequirePackage{xspace}   % spacing after macros

%%% siunitx setup
\sisetup{
input-symbols = \pi\tau,
exponent-product = \cdot  % use cdot instead of times in sci notation
}

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Page layout
\newfont{\chapterNumber}{eurb10 scaled 7000} % Numbers

%\RequirePackage[small,euler-hat-accent]{eulervm} % math font
\RequirePackage{fontspec}                         % xetex
\RequirePackage{xunicode}                         % xetex
\RequirePackage{xltxtra}                          % xetex

% To know the exact name (mac):
% Font Book> select font. In menu bar, select preview>show font info
% Type in the Full name
\setsansfont[Mapping=tex-text,Scale=0.9]{Myriad Pro}                % sans
\setmonofont[Mapping=tex-text,Scale=0.8]{Menlo}                     % mono
\defaultfontfeatures{Numbers=OldStyle}                              % before roman
\setmainfont[Mapping=tex-text]{MinionPro-Regular}                   % roman
\addfontfeature{Kerning=Uppercase}                                  % space in Uppercase

\RequirePackage[xetex]{hyperref} % pagebackref
\RequirePackage[all]{hypcap}     %

\RequirePackage[spanish]{babel}   %
\RequirePackage{datetime}         % always after hyperref
\newdateformat{docyear}{\THEYEAR} %
\RequirePackage{cleveref}         % autoref replacement (load at last)

% --------------------------------------------- Colors for doc divisions
% For gray: lower value -> darker!
\definecolor{darkergray}{gray}{0.20}
\definecolor{darkgray}{gray}{0.30}
\definecolor{halfgray}{gray}{0.50}
\definecolor{lightgray}{gray}{0.80}
\definecolor{superlightgray}{gray}{0.95}

\definecolor{Maroon}{cmyk}{0,0.87,0.68, 0.32} % classic
\definecolor{RoyalBlue4}{rgb}{0.0,0.0,0.40}   % blue
\definecolor{SlatedGrey4}{gray}{0.30}         % light gray

% ------------------------------------------------------------ Textblock
% Block area
\areaset[5mm]{288pt}{684pt}        % 609 + 33 + 42 head \the\footskip
\setlength{\marginparwidth}{9.5em} % No mod. the text block
\setlength{\marginparsep}{1.5em}   % 2em original

\DeclareRobustCommand{\spacedallcaps}[1]{\MakeTextUppercase{#1}}
\DeclareRobustCommand{\spacedlowsmallcaps}[1]{\scshape\MakeTextLowercase{#1}}

\parindent=11pt % Paragraph indentation: 1em

% Sloopy bottom
\clubpenalty=10000
\widowpenalty=10000
\displaywidowpenalty = 10000
\flushbottom
\raggedbottom

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Document divisions
% --------------------------------------------- Parts and chapters color
\newcommand{\docdivisioncolor}{darkgray}
\newcommand{\docchapternumbercolor}{lightgray}
\newcommand{\doclinkcolor}{darkergray}

% Parts
\titleformat{\part}[display]{
  \normalfont\centering\large}
            {\thispagestyle{empty}\partname~\MakeTextUppercase
              {\thepart}}{1em}
            {\color{\docdivisioncolor}\spacedallcaps
}

% Chapters
% Chapter: one line
\titleformat{\chapter}[display]
       {\relax}{\mbox{}\marginpar{\vspace*{-3\baselineskip}
           \color{darkgray}
           \chapterNumber\thechapter}}{0pt}
       {\raggedright\spacedallcaps}[\normalsize\vspace*
         {.8\baselineskip}
         \titlerule]

% ------------------------------------------------------------ Numbering
% A la Brinhurst
% ---------------------------------------------
% SECTION
\titleformat{\section}[leftmargin]                    % A la Brinhurst
            {\sc\vspace{0pt}\sc}
            {\sc\MakeTextLowercase{\thesection}}{1em}{
              \raggedleft
              %   \ifodd\thepage\raggedleft\else
              %\raggedright\fi% wise alignment
              \spacedlowsmallcaps}
            \titlespacing{\section}
                         {6em}{1.5ex plus .1ex minus .2ex}{2em}
% ---------------------------------------------
%  % SUBSECTION
\titleformat{\subsection}{\relax}{\textsc{%\color{\doclinkcolor}
    \MakeTextLowercase{\thesubsection}}}{1em}{\normalsize\itshape}

% SUBSUBSECTION: original (for all the precedents)
\titleformat{\subsubsection}{\relax}{
  \itshape %\normalsize\itshape
  \thesubsubsection}
  {1em}{\itshape}

% -------------------------------------------------------------- Headers
% Provides headers and footers (KOMA Script)
\clearscrheadings\setheadsepline{0pt}
\renewcommand{\chaptermark}[1]{\markboth{\spacedlowsmallcaps{#1}}
  {\spacedlowsmallcaps{#1}}}
\renewcommand{\sectionmark}[1]{\markright{\thesection\enspace
    \spacedlowsmallcaps{#1}}}
\lehead{\mbox{\llap{\small\thepage\kern2em}\headmark\hfil}}

% ----------------------------------------------------------- Pagination
\rohead{\mbox{\hfil{\headmark}\rlap{\small\kern2em\thepage}}} % ex: 5

\renewcommand{\headfont}{\small} % small caps, old-style numbers also

% ---------------------------------------------------------- Page styles
% Root file commands: to make a more friendly file edition
\newcommand{\frontMatterPageStyle}
{
  \frenchspacing
% To meet the ISO ISO 7144:1986 specifications and to have an agreement
% between the pdf page and the pdf viewer, Roman
% numbering was replaced by the Arabic one in the whole document
% 'what you see is what you print'
  \pagenumbering{arabic}
  \pagestyle{plain}
}%

% ------------------------------------------------- Paragraphs and lists
% Change the alignment of the bullet points and numerals in lists
\setlength{\leftmargini}{0em}

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Table of contents
\setcounter{tocdepth}{1} % where n is the level (1 for sections only)
% avoid page numbers being right-aligned in fixed-size box
\newlength{\newnumberwidth}
\settowidth{\newnumberwidth}{99}  % overfull hbox warns for pages > 99
\cftsetpnumwidth{\newnumberwidth} %
% have the bib neatly positioned after the rest
\newlength{\beforebibskip}
\setlength{\beforebibskip}{0em}

% ---------------------------------------------------------------- Parts
\renewcommand{\thepart}{\roman{part}}
\renewcommand{\cftpartpresnum}{\scshape\lowercase}
\renewcommand{\cftpartfont}{\color{\docdivisioncolor}\normalfont}
\renewcommand{\cftpartpagefont}{\normalfont}
\renewcommand{\cftpartleader}{\hspace{1.5em}}
\renewcommand{\cftpartafterpnum}{\cftparfillskip}
\setlength{\cftbeforepartskip}{1em}
\setlength{\cftbeforechapskip}{.1em}
\setlength{\beforebibskip}{\cftbeforepartskip}

% ------------------------------------------------------------- Chapters
\renewcommand{\cftchappresnum}{\scshape\MakeTextLowercase}
\renewcommand{\cftchapfont}{\scshape\lowercase}
\renewcommand{\cftchappagefont}{\normalfont}
\renewcommand{\cftchapleader}{\hspace{1.5em}}
\renewcommand{\cftchapafterpnum}{\cftparfillskip}

% ------------------------------------------------------------- Sections
\renewcommand{\cftsecpresnum}{\scshape\MakeTextLowercase}
\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsecpagefont}{\normalfont}
\renewcommand{\cftsecleader}{\hspace{1.5em}}
\renewcommand{\cftsecafterpnum}{\cftparfillskip}

% ---------------------------------------------------------- Subsections
\renewcommand{\cftsubsecpresnum}{\scshape\MakeTextLowercase}
\renewcommand{\cftsubsecfont}{\color{darkergray}
  \normalfont}
\renewcommand{\cftsubsecleader}{\hspace{1.5em}}
\renewcommand{\cftsubsecafterpnum}{\cftparfillskip}

% -------------------------------------------------------------- Figures
\renewcommand{\cftfigpresnum}{\scshape\MakeTextLowercase}
\renewcommand{\cftfigfont}{\normalfont}
\renewcommand{\cftfigleader}{\hspace{1.5em}}
\renewcommand{\cftfigpresnum}{\figurename~}
\renewcommand{\cftfigafterpnum}{\cftparfillskip}
\newlength{\figurelabelwidth}
\settowidth{\figurelabelwidth}{\cftfigpresnum~99}
\addtolength{\figurelabelwidth}{2.5em}
\cftsetindents{figure}{0em}{\figurelabelwidth}
\renewcommand{\thefigure}{\arabic{figure}}     % no chapter numbers

% --------------------------------------------------------------- Tables
\renewcommand{\cfttabpresnum}{\scshape\MakeTextLowercase}
\renewcommand{\cfttabfont}{\normalfont}
\renewcommand{\cfttableader}{\hspace{1.5em}}
\renewcommand{\cfttabpresnum}{\tablename~}
\renewcommand{\cfttabafterpnum}{\cftparfillskip}
\newlength{\tablelabelwidth}
\settowidth{\tablelabelwidth}{\cfttabpresnum~99}
\addtolength{\tablelabelwidth}{2.5em}
\cftsetindents{table}{0em}{\figurelabelwidth}
\renewcommand{\thetable}{\arabic{table}}     % no chapter numbers

% -------------------------------------------------------------- General
\AtBeginDocument{\addtocontents{toc}{\protect\vspace{-\cftbeforepartskip}}}

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Floats and captions
% Captions
% captions in fig and table font
\setkomafont{caption}{\small}

% --------------------------------------------------------- Style change
% Caption text with the left margin
\DeclareCaptionFormat{llap}{\llap{#1#2}#3\par}
\captionsetup{format=llap,labelsep=quad,singlelinecheck=no}

% Tables
\setlength{\extrarowheight}{3pt} % Increase table row height
% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Page notes
% mgraffito: middle of a paragraph graffito
\renewcommand{\raggedleftmarginnote}{{\leftskip=0pt\rightskip=0pt plus 0cm}}

\DeclareRobustCommand{\mgraffito}[1]
{
  \marginnote{{
      \begingroup
      %\rm\sffamily % roman sans serif
      \footnotesize %\small%
      \ifodd\thepage\raggedright\else\raggedleft\fi
      \parindent=0pt\lineskip=0pt\lineskiplimit=0pt %\baselineskip=10pt
      \tolerance=2000\hyphenpenalty=300\exhyphenpenalty=300
      \doublehyphendemerits=100000
      \finalhyphendemerits=\doublehyphendemerits
      \color{\docdivisioncolor}                     % graffito in graffit color?
      \hspace{0pt}{#1}
      \endgroup
      }}
}

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Back Matter
% necessary for correct hyperlinks (index, bib, etc.)
\newcounter{dummy}
\newcommand{\longpage}{\enlargethispage{3\baselineskip}}
\newcommand{\medpage}{\enlargethispage{2\baselineskip}}
\newcommand{\shortpage}{\enlargethispage{\baselineskip}}
\newcommand{\concskip}{\medskip}

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Miscellaneous
% Minor space adjustments
\newlength{\abcd}                % for ab..z string length calculation
\setlength{\extrarowheight}{3pt} % increase table row height

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Cross References
% to change the copyright note in the copyright page
% Draft documents
\newcommand{\docType}{draft}

% change copyrightpage
%%% PRELIMINARY VERSION
\renewcommand{\PrelimWords}{\relax}
\renewcommand{\PrelimText}
{{\tt\footnotesize\color{halfgray}[\,v.\docVersion\xspace\thistime\xspace\docToday\,]}}

%%% FINAL VERSION
%\renewcommand{\PrelimWords}{\relax}%
%\renewcommand{\PrelimText}{\relax}%

% >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Hypersetup
\hypersetup
{
  colorlinks=true,
  linktocpage=true,
  pdfstartpage=1,                                        % 3 for Books and 1 for Reports (3 default)
  pdfstartview=FitPage,                                  % FitH=fit height, default=FitV=fit Vertical
  breaklinks=true, pdfpagemode=UseNone, pageanchor=true,
  pdfpagemode=UseOutlines,
  plainpages=false, bookmarksnumbered, bookmarksopen=true,
  bookmarksopenlevel=1,
  hypertexnames=true, pdfhighlight=/O,
  % -------------------------------------------------------
  urlcolor= \doclinkcolor, 
  linkcolor= \doclinkcolor,
  citecolor= \doclinkcolor,
  % -------------------------------------------------------
  % The following comes from docInfo.tex
  pdftitle={\docTitle, \docSubtitle},
  pdfauthor={\docAuthor},
  pdfsubject={\docCompany},
  pdfkeywords={},
  pdfcreator={XeLaTeX with package hyperref},
  pdfproducer={XeLaTeX with hyperref and modified classicthesis}
}
